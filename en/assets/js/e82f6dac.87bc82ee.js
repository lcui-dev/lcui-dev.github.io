"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2386],{26440:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>d,default:()=>f,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"tutorial/kantu/file-info-reader","title":"\u5b9e\u73b0\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668","description":"\u672c\u7ae0\u8282\u5c06\u4ecb\u7ecd\u5982\u4f55\u5b9e\u73b0\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668\uff0c\u5b83\u4e3b\u8981\u4e3a\u5de5\u5177\u680f\u548c\u4fe1\u606f\u754c\u9762\u63d0\u4f9b\u56fe\u50cf\u6587\u4ef6\u4fe1\u606f\u3002\u5b8c\u6210\u672c\u7ae0\u540e\u4f60\u5c06\u5b66\u4f1a\uff1a","source":"@site/versioned_docs/version-3.x/tutorial/03-kantu/06-file-info-reader.md","sourceDirName":"tutorial/03-kantu","slug":"/tutorial/kantu/file-info-reader","permalink":"/en/docs/tutorial/kantu/file-info-reader","draft":false,"unlisted":false,"editUrl":"https://github.com/lcui-dev/website/tree/main/docs/versioned_docs/version-3.x/tutorial/03-kantu/06-file-info-reader.md","tags":[],"version":"3.x","sidebarPosition":6,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u5b9e\u73b0\u56fe\u50cf\u6587\u4ef6\u6536\u96c6\u5668","permalink":"/en/docs/tutorial/kantu/collector"},"next":{"title":"\u5b9e\u73b0\u4e3b\u754c\u9762","permalink":"/en/docs/tutorial/kantu/ui-home"}}');var a=i(74848),t=i(28453);const l={},d="\u5b9e\u73b0\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668",s={},c=[{value:"\u5b9a\u4e49\u6570\u636e\u7ed3\u6784",id:"\u5b9a\u4e49\u6570\u636e\u7ed3\u6784",level:2},{value:"\u521d\u59cb\u5316\u548c\u9500\u6bc1",id:"\u521d\u59cb\u5316\u548c\u9500\u6bc1",level:2},{value:"\u52a0\u8f7d\u4fe1\u606f",id:"\u52a0\u8f7d\u4fe1\u606f",level:2},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"\u5b9e\u73b0\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668",children:"\u5b9e\u73b0\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668"})}),"\n",(0,a.jsx)(n.p,{children:"\u672c\u7ae0\u8282\u5c06\u4ecb\u7ecd\u5982\u4f55\u5b9e\u73b0\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668\uff0c\u5b83\u4e3b\u8981\u4e3a\u5de5\u5177\u680f\u548c\u4fe1\u606f\u754c\u9762\u63d0\u4f9b\u56fe\u50cf\u6587\u4ef6\u4fe1\u606f\u3002\u5b8c\u6210\u672c\u7ae0\u540e\u4f60\u5c06\u5b66\u4f1a\uff1a"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u83b7\u53d6\u6587\u4ef6\u4fe1\u606f"}),"\n",(0,a.jsx)(n.li,{children:"\u83b7\u53d6\u56fe\u50cf\u4fe1\u606f"}),"\n",(0,a.jsx)(n.li,{children:"\u521b\u5efa\u548c\u53d6\u6d88 LCUI \u7684\u5f02\u6b65\u4efb\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"\u5c06\u6587\u4ef6\u5927\u5c0f\u683c\u5f0f\u5316\u6210\u6613\u8bfb\u7684\u5b57\u7b26\u4e32"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u5b9a\u4e49\u6570\u636e\u7ed3\u6784",children:"\u5b9a\u4e49\u6570\u636e\u7ed3\u6784"}),"\n",(0,a.jsx)(n.p,{children:"\u754c\u9762\u4e2d\u8981\u5c55\u793a\u7684\u4fe1\u606f\u6709\uff1a\u6587\u4ef6\u540d\u3001\u8def\u5f84\u3001\u5927\u5c0f\u3001\u5206\u8fa8\u7387\u3001\u6bd4\u7279\u4f4d\uff0c\u90a3\u4e48\u6570\u636e\u7ed3\u6784\u5c31\u80fd\u5199\u6210\u8fd9\u6837\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.h"',children:"#ifndef FILE_INFO_READER_H\n#define FILE_INFO_READER_H\n\n#include <time.h>\n\ntypedef struct file_info {\n        char name[256];\n        char file_size[32];\n        char image_size[32];\n        char *path;\n        time_t mtime;\n        unsigned width;\n        unsigned height;\n        unsigned bits;\n} file_info_t;\n\n#endif\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u662f\u8bfb\u53d6\u5668\u4ea7\u51fa\u7684\u6570\u636e\uff0c\u4e3a\u4e86\u5b9e\u73b0\u8bfb\u53d6\u529f\u80fd\u8fd8\u9700\u8981\uff1a"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ui_image_t"})," \u56fe\u50cf\u5bf9\u8c61\uff1a\u83b7\u53d6\u56fe\u50cf\u7684\u5bbd\u9ad8\u3001\u6bd4\u7279\u4f4d\u3002"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"worker_task_t"})," \u4efb\u52a1\u5bf9\u8c61\uff1a\u7ba1\u7406\u5f02\u6b65\u6587\u4ef6\u8bfb\u53d6\u4efb\u52a1\u3002"]}),"\n",(0,a.jsx)(n.li,{children:"\u56de\u8c03\u51fd\u6570\uff1a\u5728\u8bfb\u53d6\u5b8c\u6587\u4ef6\u4fe1\u606f\u540e\u901a\u77e5\u754c\u9762\u5c42\u4ee3\u7801\u66f4\u65b0\u754c\u9762\u3002"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u4e9b\u5c5e\u4e8e\u6587\u4ef6\u8bfb\u53d6\u5668\u7684\u79c1\u6709\u6570\u636e\uff0c\u53ef\u4ee5\u5b9a\u4e49\u5728\u6e90\u6587\u4ef6\u5185\u4e0d\u5bf9\u5916\u516c\u5f00\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.c"',children:'#include <ui.h>\n#include <LCUI/worker.h>\n#include "file-info-reader.h"\n\nstruct file_info_reader {\n        file_info_t file_info;\n        ui_image_t *image;\n        worker_task_t *task;\n        void (*callback)(file_info_t *, void *);\n        void *callback_arg;\n};\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.h"',children:"typedef struct file_info_reader file_info_reader_t;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u521d\u59cb\u5316\u548c\u9500\u6bc1",children:"\u521d\u59cb\u5316\u548c\u9500\u6bc1"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.c"',children:'file_info_reader_t *file_info_reader_create(void (*callback)(file_info_t *,\n                                                             void *),\n                                            void *callback_arg)\n{\n        file_info_reader_t *reader = malloc(sizeof(file_info_reader_t));\n\n        reader->file_info.bits = 32;\n        reader->file_info.file_size[0] = 0;\n        reader->file_info.image_size[0] = 0;\n        reader->file_info.name[0] = 0;\n        reader->file_info.mtime = 0;\n        reader->file_info.path = strdup2("");\n        reader->task = NULL;\n        reader->image = NULL;\n        reader->callback = callback;\n        reader->callback_arg = callback_arg;\n        return reader;\n}\n\nvoid file_info_reader_destroy(file_info_reader_t *reader)\n{\n        if (reader->task) {\n                lcui_cancel_async_task(reader->task);\n        }\n        if (reader->image) {\n                ui_image_destroy(reader->image);\n        }\n        if (reader->file_info.path) {\n                free(reader->file_info.path);\n        }\n        free(reader);\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.h"',children:"file_info_reader_t *file_info_reader_create(void (*callback)(file_info_t *,\n                                                             void *),\n                                            void *callback_arg);\n\nvoid file_info_reader_destroy(file_info_reader_t *reader);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u52a0\u8f7d\u4fe1\u606f",children:"\u52a0\u8f7d\u4fe1\u606f"}),"\n",(0,a.jsxs)(n.p,{children:["\u6587\u4ef6\u64cd\u4f5c\u5bb9\u6613\u963b\u585e\u7528\u6237\u754c\u9762\u54cd\u5e94\uff0c\u5bfc\u81f4\u51fa\u73b0\u5361\u987f\u6216\u65e0\u54cd\u5e94\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u5e94\u5c06\u6587\u4ef6\u64cd\u4f5c\u653e\u5230\u5de5\u4f5c\u7ebf\u7a0b\u4e2d\u6267\u884c\u3002LCUI \u63d0\u4f9b\u4e86\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u7528 ",(0,a.jsx)(n.code,{children:"lcui_post_async_task()"})," \u521b\u5efa\u4e00\u4e2a\u5f02\u6b65\u4efb\u52a1\u4ee5\u5728\u5de5\u4f5c\u7ebf\u7a0b\u4e2d\u6267\u884c\u6587\u4ef6\u64cd\u4f5c\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5b9a\u4e49\u6587\u4ef6\u8bfb\u53d6\u51fd\u6570\uff0c\u66f4\u65b0\u5f53\u524d\u5b58\u50a8\u7684\u6587\u4ef6\u8def\u5f84\u548c\u6587\u4ef6\u540d\u79f0\uff0c\u518d\u521b\u5efa\u5f02\u6b65\u6587\u4ef6\u8bfb\u53d6\u4efb\u52a1\u548c ",(0,a.jsx)(n.code,{children:"ui_image_t"})," \u5bf9\u8c61\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.c"',children:"#include \"utils.h\"\n\nvoid file_info_reader_load_file(file_info_reader_t *reader, const char *path)\n{\n        const char *ext;\n\n        if (reader->task) {\n                lcui_cancel_async_task(reader->task);\n        }\n        if (reader->image) {\n                ui_image_destroy(reader->image);\n        }\n        if (reader->file_info.path) {\n                free(reader->file_info.path);\n        }\n        reader->file_info.path = strdup2(path);\n        strcpy(reader->file_info.name, path_basename(path));\n        ext = str_last_char(reader->file_info.name, '.');\n        if (ext) {\n                *((char *)ext) = 0;\n        }\n        reader->image = ui_image_create(path);\n        reader->task =\n            lcui_post_async_task(reader, file_info_reader_on_load_file, NULL);\n        ui_image_on_load(reader->image, file_info_reader_on_load_image, reader);\n}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.h"',children:"void file_info_reader_load_file(file_info_reader_t *reader, const char *path);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5728\u5f02\u6b65\u4efb\u52a1\u7684\u5904\u7406\u51fd\u6570\u4e2d\uff0c\u8c03\u7528 ",(0,a.jsx)(n.code,{children:"stat()"})," \u51fd\u6570\u83b7\u53d6\u6587\u4ef6\u7684\u5927\u5c0f\u548c\u4fee\u6539\u65f6\u95f4\uff0c\u4e4b\u540e\u8c03\u7528\u56de\u8c03\u51fd\u6570\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.c"',children:'static void file_info_reader_on_load_file(void *data)\n{\n        struct stat st;\n        file_info_reader_t *reader = data;\n\n        reader->file_info.mtime = 0;\n        strcpy(reader->file_info.file_size, u8"\u672a\u77e5");\n        if (stat(reader->image->path, &st) == 0) {\n                reader->file_info.mtime = st.st_mtime;\n                format_size(reader->file_info.file_size, st.st_size);\n        }\n        if (reader->callback) {\n                reader->callback(&reader->file_info, reader->callback_arg);\n        }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u5f97\u5230\u7684\u6587\u4ef6\u5927\u5c0f\u5355\u4f4d\u662f\u5b57\u8282\uff0c\u6211\u4eec\u5b9a\u4e49 ",(0,a.jsx)(n.code,{children:"format_size()"})," \u51fd\u6570\u5c06\u5b83\u683c\u5f0f\u5316\u6210\u6613\u8bfb\u7684\u5b57\u7b26\u4e32\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/utils.c"',children:'int format_size(char buf[16], size_t size)\n{\n        const char *units[] = { "B", "KB", "MB", "GB", "TB" };\n        int i = 0;\n\n        while (size >= 1024) {\n                size /= 1024;\n                i++;\n        }\n        return snprintf(buf, 16, "%zu %s", size, units[i]);\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/utils.h"',children:"int format_size(char buf[16], size_t size);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"ui_image_t"})," \u5bf9\u8c61\u7684 load \u4e8b\u4ef6\u5904\u7406\u51fd\u6570\u4e2d\uff0c\u83b7\u53d6\u56fe\u50cf\u7684\u5bbd\u9ad8\u3001\u6bd4\u7279\u4f4d\u4fe1\u606f\uff0c\u518d\u8c03\u7528\u56de\u8c03\u51fd\u6570\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/fille-info-reader.c"',children:'#include <stdio.h>\n\nstatic void file_info_reader_on_load_image(ui_image_event_t *image_event)\n{\n        file_info_reader_t *reader = image_event->data;\n        file_info_t *info = &reader->file_info;\n\n        info->bits = 0;\n        info->width = 0;\n        info->height = 0;\n        if (ui_image_valid(image_event->image)) {\n                info->bits = image_event->image->data.bytes_per_pixel * 8;\n                info->width = image_event->image->data.width;\n                info->height = image_event->image->data.height;\n        }\n        snprintf(info->image_size, 31, "%u x %u", info->width, info->height);\n        if (reader->callback) {\n                reader->callback(&reader->file_info, reader->callback_arg);\n        }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u4e3a\u4e86\u8ba9\u754c\u9762\u5c42\u4ee3\u7801\u80fd\u591f\u83b7\u53d6\u5df2\u8bfb\u53d6\u7684\u6587\u4ef6\u4fe1\u606f\uff0c\u5b9a\u4e49\u4e00\u4e2a\u4fe1\u606f\u83b7\u53d6\u51fd\u6570\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.c"',children:"file_info_t *file_info_reader_get_info(file_info_reader_t *reader)\n{\n        return &reader->file_info;\n}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-c",metastring:'title="src/file-info-reader.h"',children:"file_info_t *file_info_reader_get_info(file_info_reader_t *reader);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u5c0f\u7ed3",children:"\u5c0f\u7ed3"}),"\n",(0,a.jsxs)(n.p,{children:["\u6211\u4eec\u5b9e\u73b0\u4e86\u4e00\u4e2a\u6587\u4ef6\u4fe1\u606f\u8bfb\u53d6\u5668\u3002\u5b9a\u4e49\u4e86\u6587\u4ef6\u4fe1\u606f\u5bf9\u8c61\u548c\u8bfb\u53d6\u5668\u5bf9\u8c61\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ee5\u53ca\u521d\u59cb\u5316\u3001\u9500\u6bc1\u3001\u52a0\u8f7d\u548c\u83b7\u53d6\u51fd\u6570\u3002\u6587\u4ef6\u4fe1\u606f\u6765\u6e90\u4e8e ",(0,a.jsx)(n.code,{children:"stat()"})," \u51fd\u6570\u8f93\u51fa\u7ed3\u679c\u548c ",(0,a.jsx)(n.code,{children:"ui_image_t"})," \u5bf9\u8c61\uff0c\u6211\u4eec\u6240\u505a\u7684\u5c31\u662f\u901a\u8fc7\u4e8b\u4ef6\u56de\u8c03\u51fd\u6570\u548c\u5f02\u6b65\u4efb\u52a1\u83b7\u53d6\u4fe1\u606f\uff0c\u7136\u540e\u5c06\u6587\u4ef6\u5927\u5c0f\u548c\u56fe\u50cf\u5927\u5c0f\u4fe1\u606f\u683c\u5f0f\u5316\u6210\u53ef\u8bfb\u7684\u5b57\u7b26\u4e32\uff0c\u65b9\u4fbf\u754c\u9762\u5c42\u4ee3\u7801\u4f7f\u7528\u3002"]})]})}function f(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>d});var r=i(96540);const a={},t=r.createContext(a);function l(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);